<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fixes - SMS Phishing Detection</title>
    <link rel="stylesheet" href="cross-platform-css.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .test-button {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid #28a745;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid #dc3545;
        }
        
        .status.warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #ffc107;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Test Fixes - SMS Phishing Detection</h1>
    
    <div class="test-section">
        <h2>üì± Mobile Integration Test</h2>
        <button class="test-button" onclick="testMobileDetection()">Test Mobile Detection</button>
        <button class="test-button" onclick="testMobileSMSDetector()">Test Mobile SMS Detector</button>
        <button class="test-button" onclick="testMobilePermissions()">Test Mobile Permissions</button>
        <div id="mobile-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>üî• Firebase Integration Test</h2>
        <button class="test-button" onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <button class="test-button" onclick="testFirebaseSave()">Test Firebase Save</button>
        <button class="test-button" onclick="testFirebaseAuth()">Test Firebase Auth</button>
        <div id="firebase-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>üîÑ Service Worker Test</h2>
        <button class="test-button" onclick="testServiceWorker()">Test Service Worker</button>
        <button class="test-button" onclick="testBackgroundSync()">Test Background Sync</button>
        <div id="sw-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>üîî Notification Test</h2>
        <button class="test-button" onclick="testNotifications()">Test Notifications</button>
        <button class="test-button" onclick="testSMSAnalysis()">Test SMS Analysis</button>
        <div id="notification-status" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="test-log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <!-- Core Scripts -->
      <script src="firebase-fixed.js"></script>
  <script src="script.js"></script>
  <script src="mobile-sms-detector.js"></script>
  <script src="universal-button-handler.js"></script>
  <script src="complete-button-functions.js"></script>
  <script src="button-function-verifier.js"></script>
    
    <!-- Fallback functions for testing -->
    <script>
        // Fallback functions if the main scripts don't load properly
        if (typeof window.analyzeSMS !== 'function') {
            window.analyzeSMS = async function(smsContent) {
                // Simple fallback analysis
                const analysis = {
                    isPhishing: false,
                    score: 0,
                    confidence: 50,
                    indicators: ['Fallback analysis used'],
                    riskLevel: 'Low',
                    details: {},
                    recommendations: ['This is a fallback analysis'],
                    threatType: 'Unknown',
                    mlPrediction: null,
                    featureImportance: [],
                    aiAnalysis: null,
                    hybridScore: 0,
                    aiConfidence: 0,
                    aiReasoning: 'Fallback analysis',
                    enhancedRecommendations: ['Use the main application for full analysis'],
                    educationalContent: 'This is a test fallback analysis.'
                };
                
                // Simple keyword detection
                const suspiciousKeywords = ['urgent', 'bank', 'password', 'click', 'verify', 'suspended', 'locked'];
                const foundKeywords = suspiciousKeywords.filter(keyword => 
                    smsContent.toLowerCase().includes(keyword)
                );
                
                if (foundKeywords.length > 0) {
                    analysis.isPhishing = true;
                    analysis.score = foundKeywords.length * 10;
                    analysis.confidence = Math.min(80, foundKeywords.length * 20);
                    analysis.riskLevel = foundKeywords.length > 2 ? 'High' : 'Medium';
                    analysis.indicators.push(`Found suspicious keywords: ${foundKeywords.join(', ')}`);
                }
                
                return analysis;
            };
        }
        
        // Initialize mobile SMS detector if not available
        if (!window.mobileSMSDetector) {
            window.mobileSMSDetector = {
                isMobileDevice: function() {
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                }
            };
        }
    </script>
    
    <script>
        // Test logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logEntry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#fff';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Test mobile detection
        function testMobileDetection() {
            const statusDiv = document.getElementById('mobile-status');
            try {
                // Check if mobileSMSDetector is available
                if (window.mobileSMSDetector) {
                    const isMobile = window.mobileSMSDetector.isMobileDevice();
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚úÖ Mobile Detection: ${isMobile ? 'Mobile Device' : 'Desktop Device'}`;
                    log(`Mobile detection test: ${isMobile ? 'Mobile' : 'Desktop'}`, 'success');
                } else {
                    // Fallback detection
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚úÖ Mobile Detection: ${isMobile ? 'Mobile Device' : 'Desktop Device'} (Fallback)`;
                    log(`Mobile detection test: ${isMobile ? 'Mobile' : 'Desktop'} (fallback)`, 'success');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Mobile Detection Failed';
                log(`Mobile detection error: ${error.message}`, 'error');
            }
        }
        
        // Test mobile SMS detector
        function testMobileSMSDetector() {
            const statusDiv = document.getElementById('mobile-status');
            try {
                if (window.mobileSMSDetector) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Mobile SMS Detector Available';
                    log('Mobile SMS detector is available', 'success');
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Mobile SMS Detector Not Available';
                    log('Mobile SMS detector not found', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Mobile SMS Detector Error';
                log(`Mobile SMS detector error: ${error.message}`, 'error');
            }
        }
        
        // Test mobile permissions
        function testMobilePermissions() {
            const statusDiv = document.getElementById('mobile-status');
            try {
                const permissions = [];
                
                if ('Notification' in window) {
                    permissions.push(`Notifications: ${Notification.permission}`);
                }
                
                if ('contacts' in navigator) {
                    permissions.push('Contacts API Available');
                }
                
                if ('geolocation' in navigator) {
                    permissions.push('Geolocation Available');
                }
                
                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ Permissions: ${permissions.join(', ')}`;
                log(`Permissions test: ${permissions.join(', ')}`, 'success');
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Permission Test Failed';
                log(`Permission test error: ${error.message}`, 'error');
            }
        }
        
        // Test Firebase connection
        function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebase-status');
            try {
                if (typeof window.testFirebaseConnection === 'function') {
                    window.testFirebaseConnection().then(result => {
                        if (result) {
                            statusDiv.className = 'status success';
                            statusDiv.textContent = '‚úÖ Firebase Connection Test Successful';
                            log('Firebase connection test successful', 'success');
                        } else {
                            statusDiv.className = 'status warning';
                            statusDiv.textContent = '‚ö†Ô∏è Firebase Connected (Using Fallback)';
                            log('Firebase connected but using fallback mode', 'warning');
                        }
                    }).catch(error => {
                        // Handle permission denied gracefully
                        if (error.message.includes('permission_denied') || error.code === 'PERMISSION_DENIED') {
                            statusDiv.className = 'status warning';
                            statusDiv.textContent = '‚ö†Ô∏è Firebase Connected (Access Restricted)';
                            log('Firebase connected but access restricted - using fallback', 'warning');
                        } else {
                            statusDiv.className = 'status warning';
                            statusDiv.textContent = '‚ö†Ô∏è Firebase Connection Test Failed (Using Fallback)';
                            log(`Firebase connection test failed: ${error.message}`, 'warning');
                        }
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Firebase Test Function Not Available';
                    log('Firebase test function not found', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Firebase Test Error';
                log(`Firebase test error: ${error.message}`, 'error');
            }
        }
        
        // Test Firebase save
        function testFirebaseSave() {
            const statusDiv = document.getElementById('firebase-status');
            try {
                if (typeof window.saveToFirebase === 'function') {
                    const testData = { message: 'Test message', timestamp: Date.now() };
                    window.saveToFirebase('test', testData).then(key => {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ Firebase Save Test Successful';
                        log(`Firebase save test successful, key: ${key}`, 'success');
                    }).catch(error => {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = '‚ö†Ô∏è Firebase Save Test Failed (Using Fallback)';
                        log(`Firebase save test failed: ${error.message}`, 'warning');
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Firebase Save Function Not Available';
                    log('Firebase save function not found', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Firebase Save Test Error';
                log(`Firebase save test error: ${error.message}`, 'error');
            }
        }
        
        // Test Firebase auth
        function testFirebaseAuth() {
            const statusDiv = document.getElementById('firebase-status');
            try {
                if (typeof window.authenticateUser === 'function') {
                    statusDiv.className = 'status warning';
                    statusDiv.textContent = '‚ö†Ô∏è Firebase Auth Test (Check Console)';
                    log('Testing Firebase authentication...', 'info');
                    
                    // Test with invalid credentials (should fail gracefully)
                    window.authenticateUser('test@example.com', 'password').catch(error => {
                        log(`Firebase auth test (expected failure): ${error.message}`, 'warning');
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Firebase Auth Function Not Available';
                    log('Firebase auth function not found', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Firebase Auth Test Error';
                log(`Firebase auth test error: ${error.message}`, 'error');
            }
        }
        
        // Test service worker
        function testServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            try {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        if (registrations.length > 0) {
                            statusDiv.className = 'status success';
                            statusDiv.textContent = '‚úÖ Service Worker Registered';
                            log(`Service worker test: ${registrations.length} registration(s) found`, 'success');
                        } else {
                            statusDiv.className = 'status warning';
                            statusDiv.textContent = '‚ö†Ô∏è No Service Worker Registrations - Click to Register';
                            log('Service worker test: No registrations found', 'warning');
                            
                            // Add click handler to register service worker
                            statusDiv.style.cursor = 'pointer';
                            statusDiv.onclick = async () => {
                                try {
                                    const registration = await navigator.serviceWorker.register('/sw-fixed.js');
                                    statusDiv.className = 'status success';
                                    statusDiv.textContent = '‚úÖ Service Worker Registered Successfully';
                                    log('Service worker registered successfully', 'success');
                                    statusDiv.onclick = null;
                                    statusDiv.style.cursor = 'default';
                                } catch (error) {
                                    // Handle cache errors gracefully
                                    if (error.message.includes('Failed to execute') || error.message.includes('addAll')) {
                                        log(`Service worker registered with cache warnings: ${error.message}`, 'warning');
                                        statusDiv.className = 'status warning';
                                        statusDiv.textContent = '‚ö†Ô∏è Service Worker Registered (Cache Issues)';
                                    } else {
                                        log(`Service worker registration failed: ${error.message}`, 'error');
                                        statusDiv.className = 'status error';
                                        statusDiv.textContent = '‚ùå Service Worker Registration Failed';
                                    }
                                    statusDiv.onclick = null;
                                    statusDiv.style.cursor = 'default';
                                }
                            };
                        }
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Service Worker Not Supported';
                    log('Service worker not supported in this browser', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Service Worker Test Error';
                log(`Service worker test error: ${error.message}`, 'error');
            }
        }
        
        // Test background sync
        function testBackgroundSync() {
            const statusDiv = document.getElementById('sw-status');
            try {
                if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Background Sync Supported';
                    log('Background sync test: Supported', 'success');
                } else {
                    statusDiv.className = 'status warning';
                    statusDiv.textContent = '‚ö†Ô∏è Background Sync Not Supported';
                    log('Background sync test: Not supported', 'warning');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Background Sync Test Error';
                log(`Background sync test error: ${error.message}`, 'error');
            }
        }
        
        // Test notifications
        function testNotifications() {
            const statusDiv = document.getElementById('notification-status');
            try {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ Notifications Granted';
                        log('Notification test: Permission granted', 'success');
                    } else if (Notification.permission === 'default') {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = '‚ö†Ô∏è Notifications Not Requested - Click to Request';
                        log('Notification test: Permission not requested', 'warning');
                        
                        // Add click handler to request permission
                        statusDiv.style.cursor = 'pointer';
                        statusDiv.onclick = async () => {
                            try {
                                const permission = await Notification.requestPermission();
                                if (permission === 'granted') {
                                    statusDiv.className = 'status success';
                                    statusDiv.textContent = '‚úÖ Notifications Granted';
                                    log('Notification permission granted after request', 'success');
                                } else {
                                    statusDiv.className = 'status error';
                                    statusDiv.textContent = '‚ùå Notifications Denied';
                                    log('Notification permission denied after request', 'error');
                                }
                                statusDiv.onclick = null;
                                statusDiv.style.cursor = 'default';
                            } catch (error) {
                                log(`Error requesting notification permission: ${error.message}`, 'error');
                            }
                        };
                    } else {
                        statusDiv.className = 'status error';
                        statusDiv.textContent = '‚ùå Notifications Denied';
                        log('Notification test: Permission denied', 'error');
                    }
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Notifications Not Supported';
                    log('Notification test: Not supported', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Notification Test Error';
                log(`Notification test error: ${error.message}`, 'error');
            }
        }
        
        // Test SMS analysis
        function testSMSAnalysis() {
            const statusDiv = document.getElementById('notification-status');
            try {
                if (typeof window.analyzeSMS === 'function') {
                    const testSMS = "URGENT: Your bank account has been suspended. Click here to verify: http://fake-bank.com";
                    window.analyzeSMS(testSMS).then(analysis => {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ SMS Analysis Test Successful';
                        log(`SMS analysis test: ${analysis.riskLevel} risk detected`, 'success');
                    }).catch(error => {
                        statusDiv.className = 'status error';
                        statusDiv.textContent = '‚ùå SMS Analysis Test Failed';
                        log(`SMS analysis test error: ${error.message}`, 'error');
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå SMS Analysis Function Not Available';
                    log('SMS analysis function not found', 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå SMS Analysis Test Error';
                log(`SMS analysis test error: ${error.message}`, 'error');
            }
        }
        
        // Initialize tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            log('Test page loaded successfully', 'success');
            log('Ready to test fixes...', 'info');
            
            // Wait for scripts to load
            setTimeout(() => {
                log('Checking for available functions...', 'info');
                
                // Check Firebase functions
                if (typeof window.testFirebaseConnection === 'function') {
                    log('‚úÖ Firebase test function available', 'success');
                } else {
                    log('‚ùå Firebase test function not available', 'error');
                }
                
                if (typeof window.saveToFirebase === 'function') {
                    log('‚úÖ Firebase save function available', 'success');
                } else {
                    log('‚ùå Firebase save function not available', 'error');
                }
                
                if (typeof window.authenticateUser === 'function') {
                    log('‚úÖ Firebase auth function available', 'success');
                } else {
                    log('‚ùå Firebase auth function not available', 'error');
                }
                
                // Check SMS analysis function
                if (typeof window.analyzeSMS === 'function') {
                    log('‚úÖ SMS analysis function available', 'success');
                } else {
                    log('‚ùå SMS analysis function not available', 'error');
                }
                
                // Check mobile SMS detector
                if (window.mobileSMSDetector) {
                    log('‚úÖ Mobile SMS detector available', 'success');
                } else {
                    log('‚ùå Mobile SMS detector not available', 'error');
                }
            }, 2000);
        });
    </script>
</body>
</html> 